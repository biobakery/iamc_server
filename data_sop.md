# IAMC Data Depot SOP

## IAMC files and directories
1. `README`: table of contents with project numbers and dataset info.
2. `data.toml`: machine-readable documentation of directory contents
1. `analysis_all/`: folder containing

## Procedures

### Downloading raw sequences from WTCHG

1. The WTCHG will provide a download link when sequences are available.
2. Raw sequences will be downloaded by Nicholas Illot to archive server.
3. Checksums will be validated (Nick) to insure data integrity (see below for specific procedure).
4. Nick will also notify Brian/Kelsey/Kevin that sequences are ready for analysis,
  and will forward the WTCHG email with download details.

#### Downloading Initial lane(s) for a given batch

##### Step1: Download Files

Download files from ftp.
The WTCHG will provide an ftp link that contains authentication,
so you can simple do `$ wget {link} ./`.
This download should contain:

1. compressed fastq files for each sample/lane (with extension `.fastq.gz`),
2. BAM alignment files for each sample/lane (`.bam`)
3. BAM index files for each sample/lane (`.bai`)
4. a QC file (`.zip`)
5. an MD5 checksum file (`.txt`)


##### Step 3: Rename repeatable files

Because subsequent lanes sent by the WTCHG will use the same file name for
the `md5sum` and `QC` files, rename them. Eg, if the first download contained
the first two lanes of batch002:

```
[harviamc@iamc batch002]$ mv P170482-md5sum.txt P170482-md5sum-batch002-lane1-2.txt
[harviamc@iamc batch002]$ mv P170482-QC.zip  P170482-QC-lane1-2.zip
```

#### Downloading Subsequent lane(s) for a given batch

##### Step 1: Check current QC and md5sum file to prevent overwriting

As before, navigate to the correct batch folder. Use `ls` to ensure that any
`md5sum.txt` in the root directory and `.zip` files in the `qc/` directory have
lane information in their file names. The WTCHG uses the same name for each set
of files for a given project, so if these files haven't been renamed, they will
be overwritten. If these files do not contain `laneX` in the file name, perform
step 4 above.

##### Step 2: Get New Files

Follow the same procedure as Step 2 above.

##### Step 3: Append checksum info to appropriate files

Be careful not to overwrite files with the same name.
Instead, use the double greater than `>>` to *append* to the proper file:

```sh
[harviamc@iamc batch002]$ cat P170482-md5sum.txt >> batch002-md5sum.txt
```

##### Step 4: Rename repeatable files

Same as Step 4 above

### Verifying file transfers with md5sum

Files downloaded from the sequencing core are accompanied by a text file
containing md5 checksum values. One all files have been transferred, the
integrity of the transfer can be verified by moving into the appropriate
directory and running the command:

```sh
$ md5sum -c <md5_file.txt>
```

Where `<md5_file.txt>`  is the checksum file generated by the sequencing core.
This command will print each file name, and at the end will report if any errors
were generated. For example:

```
WTCHG_406782_201191.bam: OK
WTCHG_406782_201191.bam.bai: OK
WTCHG_406782_201191_1.fastq.gz: OK
WTCHG_406782_201191_2.fastq.gz: OK
WTCHG_406782_202179.bam: FAILED
WTCHG_406782_202179.bam.bai: OK
WTCHG_406782_202179_1.fastq.gz: OK
WTCHG_406782_202179_2.fastq.gz: OK
WTCHG_406782_203167.bam: OK
WTCHG_406782_203167.bam.bai: OK
md5sum: WARNING: 1 computed checksum did NOT match
```

Other critical files being transferred to the datastore should have md5 checksum
files generated as well to ensure data integrity. For example, before
transferring a folder containing data tables, navigate the the folder containing
the tables and then use the command:

```sh
$ md5sum * > my_checksum.md5
```

Then transfer this file along with the data tables to the datastore, and then
use `md5sum -c` to check that the files were properly transferred.

Note: the relative file paths are stored in the checksum file. If you generate
the file from outside the folder containing the files, they will need to have
the same folder names when moved to the server for the command to work.
